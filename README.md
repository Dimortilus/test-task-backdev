
## Test task BackDev
Тестовое задание на позицию Junior Backend Developer

#### Используемые технологии:
<ul>
<li>Go</li>
<li>JWT</li>
<li>MongoDB</li>
</ul>

#### Задание:
Написать часть сервиса аутентификации.</br>
Два REST маршрута:</br>
<ul>
<li>Первый маршрут выдает пару Access, Refresh токенов для пользователя с идентификатором (GUID) указанным в параметре запроса</li>
<li>Второй маршрут выполняет Refresh операцию на пару Access, Refresh токенов</li>
</ul>

#### Требования:
Access токен тип JWT, алгоритм SHA512, хранить в базе строго запрещено.</br>
Refresh токен тип произвольный, формат передачи base64, хранится в базе исключительно в виде bcrypt хеша, должен быть защищен от изменения настороне клиента и попыток повторного использования.</br>
Access, Refresh токены обоюдно связаны, Refresh операцию для Access токена можно выполнить только тем Refresh токеном который был выдан вместе с ним.

#### Описание решения:
<ul>
    <li>
    Формат Refresh токена: случайная последовательность из 32 байт.</br>
    Для каждого токена генерируется новая последовательность.</br>
    Такой тип токенов, судя по всему, называется "opaque token", или "reference token".</br>
    </li>
    <li>На клиенте оба типа токенов хранятся в httpOnly cookies.</li>
    <li>Схема "один пользователь - один Refresh токен".</br>
    В Mongo хранится <em>документ</em> со следующими полями:</br>
    - GUID</br>
    - bcrypt хеш Refresh токена</br>
    - "exp", время истечения срока годности (Unix timestamp)</br>
    - bcrypt хеш (раскодированной из base64rawURL) сигнатуры Access токена</br>
    Хранить GUID необходимо для возможности досрочного отзыва Refresh токена конкретного пользователя.</br>
    Хранить exp (expirtaion time) необходимо для проверки Refresh токена на предмет истечения срока годности.</li>
    Хранить bcrypt хеш подписи Access токена необходимо для проверки связи предъявляемой пары Access и Refresh токенов. Длина раскодированной из base64rawURL подписи JWT токена с использованием алгоритма HMACSHA512 составляет 64 байта, что позволяет применять к ней bcrypt хеширование. Максимальная длина пароля которую принимает функция <code>bcrypt.GenerateFromPassword()</code> составляет 72 байта.</li>
    <li>POST запрос по маршруту <code>/generate-tokens</code>.</br> 
    Сервер извлекает GUID из JSON тела запроса.</br>
        <ol>
            <li>Генерирует новую пару Access-Refresh токенов.</li>
            <li>Выполняет upsert <em>документа</em> по GUID в Mongo.</li>
            <li>Кодирует Refresh токен в base64.</li>
            <li>Сохраняет токены в cookies пользователя.</li>
        </ol>
    </li>
    <li>POST запрос по маршруту <code>/refresh-tokens</code>.</br>
    Сервер извлекает GUID из JSON тела запроса.</br>
    Ищет в Mongo <em>документ</em> по GUID.</br>
    Если <em>документ</em> НЕ найден, отказывает в выдаче токенов.</br>
    Если <em>документ</em> найден:</br>
    - Извлекает из cookies Access токен.</br> 
    - Валидирует Access токен (подпись, срок годности).</br>
    - Проверяет Access токен, проверяя его подпись её bcrypt хешем из <em>документа</em>.</br>
    - Извлекает из cookies Refresh токен, декодирует из base64.</br> 
    - Проверяет Refresh токен его bcrypt хешем из <em>документа</em>.</br>
    - Проверяет не истёк ли у Refresh токена срок годности.</br>
    Если валидация токенов прошла успешно:
        <ol>
            <li>Генерирует новую пару Access-Refresh токенов.</li>
            <li>Выполняет upsert <em>документа</em> по GUID в Mongo.</li>
            <li>Кодирует Refresh токен в base64.</li>
            <li>Сохраняет токены в cookies пользователя.</li>
        </ol>
    </li>
    <li>POST запрос по маршруту <code>/test-access-token</code>.</br>
    Сервер извлекает Access токен из cookies, выполняет парсинг и валидацию токена (подпись, срок годности).
    </li>
    <li>POST запрос по маршруту <code>/replace-token-cookie</code>.</br>
    Сервер выполняет в cookie подмену текущего Access или Refresh токена на переданный в JSON запроса.
    Поле JSON запроса для токена, который требуется оставить прежним, заполнено пустой строкой.
    Используется для тестирования связности Access и Refresh токенов во время Refresh операции.
    </li>
    <li>
    Переменная ACCESS_TOKEN_SECRET в .env файле заполнена тестовым ключом в виде HEX-строки.</br>
    В соответствии с рекомендациями, длина ключа для алгоритма SHA512 составляет 1024 бит.
    </li>
</ul>